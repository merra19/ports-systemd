# description	: Samba Suite Version 4
# depends	: glibc libarchive perl icu libtasn1 perl-parse-yapp popt 
# depends	: e2fsprogs libcap ncurses readline zlib libxcrypt gnutls
# depends	: acl cups jansson pam libtirpc dbus rpcsvc-proto fuse
# depends	: gpgme lmdb libaio libnsl py3-markdown avahi talloc
# depends	: libxslt gnupg libgcrypt libunwind nss vala
# optional	: krb5 openldap

pkgname=samba
pkgver=4.22.4
pkgrel=1
source=(https://download.samba.org/pub/samba/stable/$pkgname-$pkgver.tar.gz)

build() {
    cd $pkgname-$pkgver

    python3 -m venv pyvenv &&
    ./pyvenv/bin/pip3 install cryptography pyasn1 iso8601

    PYTHON=$PWD/pyvenv/bin/python3 \
    PATH=$PWD/pyvenv/bin:$PATH \
    ./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
        --with-piddir=/run/samba \
        --with-pammodulesdir=/usr/lib/security \
        --enable-fhs \
        --without-ad-dc \
        --without-systemd \
        --with-system-mitkrb5 \
        --enable-selftest \
        --disable-rpath-install 
    make

    # Fix hard coded paths to Python 3 interpreter:
    sed '1s@^.*$@#!/usr/bin/python3@' \
        -i ./bin/default/source4/scripting/bin/*.inst

    make DESTDIR="$pkgdir" install

    install -v -m644    examples/smb.conf.default "$pkgdir"/etc/samba

    sed -e "s;log file =.*;log file = /var/log/samba/%m.log;" \
        -e "s;path = /usr/spool/samba;path = /var/spool/samba;" \
        -i "$pkgdir"/etc/samba/smb.conf.default

    mkdir -pv "$pkgdir"/etc/openldap/schema

    install -v -m644    examples/LDAP/README \
                        "$pkgdir"/etc/openldap/schema/README.samba

    install -v -m644    examples/LDAP/samba* \
                        "$pkgdir"/etc/openldap/schema

    install -v -m755    examples/LDAP/{get*,ol*} \
                        "$pkgdir"/etc/openldap/schema
}