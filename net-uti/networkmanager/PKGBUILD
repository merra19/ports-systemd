# description	: A set of co-operative tools that make networking simple and straightforward
# depends	: gobject-introspection vala glib libndp curl util-linux 
# depends	: nss readline newt intltool libxslt polkit iptables
# depends	: py3-gobject wpa_supplicant systemd libpsl bluez perl
# depends	: linux-api-headers jansson libnvme modemmanager upower
# depends	: dhcpcd

pkgname=networkmanager
pkgver=1.54.0
pkgrel=1
source=(https://gitlab.freedesktop.org/NetworkManager/NetworkManager/-/releases/$pkgver/downloads/NetworkManager-$pkgver.tar.xz
        NetworkManager.conf polkit.conf no-dns-update.conf rules $pkgname.hooks)
backup=(etc/NetworkManager/NetworkManager.conf)

build() {
	cd NetworkManager-$pkgver

	grep -rl '^#!.*python$' | xargs sed -i '1s/python/&3/'

    CXXFLAGS="$CXXFLAGS -fPIC" \
	meson setup \
        --prefix=/usr \
        --buildtype=plain \
		-D libaudit=no \
		-D libpsl=true \
		-D nmtui=true \
		-D ovs=true \
		-D ppp=false \
		-D selinux=false \
        -D session_tracking=systemd \
		-D modem_manager=false \
		-D qt=false \
        build
	ninja -C build
	DESTDIR="$pkgdir" ninja install -C build

    for file in $(echo man/*.[1578]); do
        section=${file##*.} &&
        install -vdm 755 "$pkgdir"/usr/share/man/man$section
        install -vm 644 $file "$pkgdir"/usr/share/man/man$section/
    done

    mv -v "$pkgdir"/usr/share/doc/NetworkManager "$pkgdir"/usr/share/doc/NetworkManager-$pkgver
    cp -Rv docs/{api,libnm} "$pkgdir"/usr/share/doc/NetworkManager-$pkgver

    install -Dm 644 "$srcdir"/NetworkManager.conf "$pkgdir"/etc/NetworkManager/NetworkManager.conf
    install -Dm 644 "$srcdir"/polkit.conf "$pkgdir"/etc/NetworkManager/conf.d/polkit.conf
    install -Dm 644 "$srcdir"/no-dns-update.conf "$pkgdir"/etc/NetworkManager/conf.d/no-dns-update.conf
    install -Dm 644 "$srcdir"/rules "$pkgdir"/usr/share/polkit-1/rules.d/org.freedesktop.NetworkManager.rules

    install -Dm755 "$srcdir"/$pkgname.hooks "$pkgdir"/usr/share/blfs-bootscripts/hooks/$pkgname.hooks
}