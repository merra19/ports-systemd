# description	: System which facilitates service discovery on a local network
# depends	: libdaemon libevent expat glib dbus libcap py3-dbus gdbm
# depends	: gobject-introspection systemd

pkgname=avahi
pkgver=0.8
pkgrel=1
options=(!makeflags)
source=(https://github.com/lathiat/avahi/releases/download/v$pkgver/$pkgname-$pkgver.tar.gz
        https://www.linuxfromscratch.org/patches/blfs/12.4/avahi-0.8-ipv6_race_condition_fix-1.patch
        $pkgname.hooks)
backup=(etc/avahi/hosts etc/avahi/avahi-daemon.conf etc/avahi/avahi-autoipd.action etc/avahi/avahi-dnsconfd.action)

build() {
	cd $pkgname-$pkgver

    patch -Np1 -i ../avahi-0.8-ipv6_race_condition_fix-1.patch

    #Fix a security vulnerability in avahi-daemon:

    sed -i '426a if (events & AVAHI_WATCH_HUP) { \
    client_free(c); \
    return; \
    }' avahi-daemon/simple-protocol.c

    scratch isinstalled gtk3 ||  OPT_GTK3='-disable-gtk3'

	./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
        --disable-static \
        --enable-libevent \
        --disable-mono \
        --disable-monodoc \
        --disable-python \
        --disable-qt3 \
        --disable-qt4 \
        --disable-qt5 \
        --enable-core-docs \
        --with-distro=none \
        --with-dbus-system-address='unix:path=/run/dbus/system_bus_socket' \
        $OPT_GTK3
	make
    make DESTDIR="$pkgdir" install

    mkdir -pv "$pkgdir"/etc/systemd/resolved.conf.d
    cat > "$pkgdir"/etc/systemd/resolved.conf.d/no-mdns.conf << EOF
[Resolve]
MulticastDNS=no
EOF

    install -Dm755 "$srcdir"/$pkgname.hooks "$pkgdir"/usr/share/blfs-bootscripts/hooks/$pkgname.hooks
}
