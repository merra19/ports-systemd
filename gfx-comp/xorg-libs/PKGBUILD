# description	: Xorg libraries
# depends	: libxcb fontconfig xmlto

pkgname=xorg-libs
pkgver=1.0.0
pkgrel=3
source=()
noextract=(
    xtrans-1.6.0.tar.xz
    libX11-1.8.12.tar.xz
    libXext-1.3.6.tar.xz
    libFS-1.0.10.tar.xz
    libICE-1.1.2.tar.xz
    libSM-1.2.6.tar.xz
    libXScrnSaver-1.2.4.tar.xz
    libXt-1.3.1.tar.xz
    libXmu-1.2.1.tar.xz
    libXpm-3.5.17.tar.xz
    libXaw-1.0.16.tar.xz
    libXfixes-6.0.1.tar.xz
    libXcomposite-0.4.6.tar.xz
    libXrender-0.9.12.tar.xz
    libXcursor-1.2.3.tar.xz
    libXdamage-1.1.6.tar.xz
    libfontenc-1.1.8.tar.xz
    libXfont2-2.0.7.tar.xz
    libXft-2.3.9.tar.xz
    libXi-1.8.2.tar.xz
    libXinerama-1.1.5.tar.xz
    libXrandr-1.5.4.tar.xz
    libXres-1.2.3.tar.xz
    libXtst-1.2.5.tar.xz
    libXv-1.0.13.tar.xz
    libXvMC-1.0.14.tar.xz
    libXxf86dga-1.1.6.tar.xz
    libXxf86vm-1.1.6.tar.xz
    libpciaccess-0.18.1.tar.xz
    libxkbfile-1.1.3.tar.xz
    libxshmfence-1.3.3.tar.xz
    libXpresent-1.0.2.tar.xz
)

for listsrc in ${noextract[@]};do
    source=(${source[@]} https://www.x.org/pub/individual/lib/$listsrc)
done

build() {
    export XORG_PREFIX=/usr
    export XORG_CONFIG="--prefix=$XORG_PREFIX --sysconfdir=/etc \
    --localstatedir=/var --disable-static"

    export PKG_CONFIG_PATH="$pkgdir/usr/lib/pkgconfig:$pkgdir/usr/share/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig"
    export PKG_CONFIG_LIBDIR="$pkgdir/usr/lib/pkgconfig:$pkgdir/usr/share/pkgconfig:/usr/lib/pkgconfig:/usr/share/pkgconfig"

    export CFLAGS="$CFLAGS -L$pkgdir/usr/lib -I$pkgdir/usr/include"

    for packagex in ${noextract[@]}
    do
        packagedir=${packagex%.tar.?z*}
        tar -xf $packagex

        docdir="--docdir=$XORG_PREFIX/share/doc/$packagedir"

        pushd $packagedir

        case $packagedir in
            libXfont2-[0-9]*)
                ./configure $XORG_CONFIG $docdir --disable-devel-docs
            ;;
            libXt-[0-9]*)
                ./configure $XORG_CONFIG $docdir \
                            --with-appdefaultdir=/etc/X11/app-defaults
            ;;
            libXpm-[0-9]*)
                ./configure $XORG_CONFIG $docdir --disable-open-zfile
            ;;
            libpciaccess*)
                meson setup \
                    --prefix=/usr \
                    --buildtype=plain \
                    build
                ninja -C build
                DESTDIR="$pkgdir" ninja install -C build
                popd
                continue
            ;;
            *)
                ./configure $XORG_CONFIG $docdir
            ;;
        esac
        LD_LIBRARY_PATH="$pkgdir/usr/lib" make
        make DESTDIR="$pkgdir" install
        find "$pkgdir" ! -type d -name "*.la" -delete
        popd
        rm -rf $packagedir
    done  
}
