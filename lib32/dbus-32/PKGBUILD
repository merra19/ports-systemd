# description	: A message bus system, a simple way for applications to talk to each other
# depends	: expat-32 xorg-libs-32 dbus

pkgname=dbus-32
_pkgname=dbus
pkgver=1.16.2
pkgrel=1
source=(https://dbus.freedesktop.org/releases/dbus/${_pkgname}-$pkgver.tar.xz
        malloc_trim.patch memory.patch)

build() {
    cd ${_pkgname}-$pkgver

    patch -Np1 -i ../malloc_trim.patch
    patch -Np1 -i ../memory.patch

	export CC="gcc -m32 -mstackrealign"
	export CXX="g++ -m32 -mstackrealign"
	export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"

    meson setup \
        --prefix=/usr \
        --buildtype=plain \
        --libdir=/usr/lib32 \
        --libexecdir=/usr/lib32/dbus \
        --wrap-mode=nofallback \
        --cross-file lib32 \
        p11-build 
    ninja -C p11-build 
    DESTDIR="$PWD"/DESTDIR ninja install -C p11-build

    rm -fr DESTDIR/{var,etc,usr/{bin,share,lib,include}}
    cp -Rv DESTDIR/* "$pkgdir"/

    find 

    chown -v root:messagebus "$pkgdir"/usr/lib32/dbus/dbus-daemon-launch-helper &&
    chmod -v      4750       "$pkgdir"/usr/lib32/dbus/dbus-daemon-launch-helper
}