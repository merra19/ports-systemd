# description	: Provides an API and commands for processing SPIR-V modules
# depends	: spirv-tools

pkgname=spirv-tools-32
pkgver=1.4.321.0
pkgrel=1
options=(!lto)
source=(https://github.com/KhronosGroup/SPIRV-Tools/archive/refs/tags/vulkan-sdk-$pkgver/SPIRV-Tools-$pkgver.tar.gz)

build() {
    cd SPIRV-Tools-vulkan-sdk-$pkgver

	export CC="gcc -m32 -mstackrealign"
	export CXX="g++ -m32 -mstackrealign"
	export PKG_CONFIG_LIBDIR="/usr/lib32/pkgconfig"

    cmake -B build32 -G Ninja \
        -D CMAKE_INSTALL_PREFIX=/usr \
		-D CMAKE_BUILD_TYPE=Release \
        -D CMAKE_INSTALL_LIBDIR=lib32 \
		-D CMAKE_C_FLAGS_RELEASE="$CFLAGS -m32" \
		-D CMAKE_CXX_FLAGS_RELEASE="$CXXFLAGS -m32" \
		-D BUILD_SHARED_LIBS=ON \
		-D SPIRV_TOOLS_BUILD_STATIC=OFF \
		-D SPIRV_WERROR=OFF \
		-D SPIRV-Headers_SOURCE_DIR=/usr \
        -Wno-dev
    ninja -C build32
    DESTDIR="$PWD/dest" ninja install -C build32

    rm -r dest/usr/{bin,include}
    cp -R dest/* "$pkgdir"/
}