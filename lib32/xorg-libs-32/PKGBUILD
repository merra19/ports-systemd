# description	: Xorg libraries
# depends	: libxcb-32 fontconfig-32 xmlto xorg-libs

pkgname=xorg-libs-32
pkgver=1.0.0
pkgrel=3
source=()
noextract=(
    xtrans-1.6.0.tar.xz
    libX11-1.8.12.tar.xz
    libXext-1.3.6.tar.xz
    libFS-1.0.10.tar.xz
    libICE-1.1.2.tar.xz
    libSM-1.2.6.tar.xz
    libXScrnSaver-1.2.5.tar.xz
    libXt-1.3.1.tar.xz
    libXmu-1.2.1.tar.xz
    libXpm-3.5.17.tar.xz
    libXaw-1.0.16.tar.xz
    libXfixes-6.0.2.tar.xz
    libXcomposite-0.4.6.tar.xz
    libXrender-0.9.12.tar.xz
    libXcursor-1.2.3.tar.xz
    libXdamage-1.1.6.tar.xz
    libfontenc-1.1.8.tar.xz
    libXfont2-2.0.7.tar.xz
    libXft-2.3.9.tar.xz
    libXi-1.8.2.tar.xz
    libXinerama-1.1.5.tar.xz
    libXrandr-1.5.4.tar.xz
    libXres-1.2.3.tar.xz
    libXtst-1.2.5.tar.xz
    libXv-1.0.13.tar.xz
    libXvMC-1.0.14.tar.xz
    libXxf86dga-1.1.6.tar.xz
    libXxf86vm-1.1.6.tar.xz
    libpciaccess-0.18.1.tar.xz
    libxkbfile-1.1.3.tar.xz
    libxshmfence-1.3.3.tar.xz
    libXpresent-1.0.2.tar.xz
)

for listsrc in ${noextract[@]};do
    source=(${source[@]} https://www.x.org/pub/individual/lib/$listsrc)
done


build() {
    export XORG_PREFIX=/usr
    export XORG_CONFIG="--prefix=$XORG_PREFIX --sysconfdir=/etc \
    --localstatedir=/var --disable-static --libdir=/usr/lib32 \
    --libexecdir=/usr/lib32--host=i686-pc-linux-gnu"

    export PKG_CONFIG_PATH="$pkgdir/usr/lib32/pkgconfig:$pkgdir/usr/share/pkgconfig:/usr/lib32/pkgconfig:/usr/share/pkgconfig"
    export PKG_CONFIG_LIBDIR="$pkgdir/usr/lib32/pkgconfig:$pkgdir/usr/share/pkgconfig:/usr/lib32/pkgconfig:/usr/share/pkgconfig"

	export CC="gcc -m32 -mstackrealign"
	export CXX="g++ -m32 -mstackrealign"

    export CFLAGS="$CFLAGS -L$pkgdir/usr/lib32 -I$pkgdir/usr/include"

    mkdir -p "$pkgdir"/usr/lib32

    for packagex in ${noextract[@]}
    do

        packagedir=${packagex%.tar.?z*}
        tar -xf $packagex

        docdir="--docdir=$XORG_PREFIX/share/doc/$packagedir"

        pushd $packagedir

        case $packagedir in
            xtrans*)
                popd ;rm -rf $packagedir ; continue ;;
            libXfont2-[0-9]*)
                ./configure $XORG_CONFIG $docdir --disable-devel-docs 
            ;;
            libXt-[0-9]*)
                ./configure $XORG_CONFIG $docdir \
                            --with-appdefaultdir=/etc/X11/app-defaults
            ;;
            libXpm-[0-9]*)
                ./configure $XORG_CONFIG $docdir --disable-open-zfile
            ;;
            libpciaccess*)
                meson setup \
                    --prefix=/usr \
                    --buildtype=plain \
                    --libdir=/usr/lib32 \
                    --libexecdir=/usr/lib32 \
                    build
                ninja -C build
                DESTDIR="$PWD"/DESTDIR ninja install -C build
                cp -Rv DESTDIR/usr/lib32/* "$pkgdir"/usr/lib32
                popd
                continue
            ;;
            *)
                ./configure $XORG_CONFIG $docdir
            ;;
        esac
        LD_LIBRARY_PATH="$pkgdir/usr/lib32" make
        make DESTDIR=$PWD/DESTDIR install
        cp -Rv DESTDIR/usr/lib32/* "$pkgdir"/usr/lib32
        rm -f "$pkgdir"/usr/lib32/*.la
        popd
        rm -rf $packagedir
    done  
}
