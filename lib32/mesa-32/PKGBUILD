# description	: OpenGL-like graphic library for Linux
# depends	: elfutils-32 libdrm-32 llvm32 libglvnd-32 lm-sensors-32
# depends	: vulkan-loader-32 libgcrypt-32 expat-32 zlib-32 zstd-32
# depends	: xorg-libs-32 libxcb-32 libva-32 libvdpau-32 nettle-32
# depends	: spirv-tools-32 spirv-llvm-translator-32 mesa

pkgname=mesa-32
_pkgname=mesa
pkgver=25.2.2
pkgrel=1
options=(!lto)
syn=2.0.87
unicodeident=1.0.12
quote=1.0.35
procmacro2=1.0.86
paste=1.0.14
source=(https://mesa.freedesktop.org/archive/${_pkgname}-$pkgver.tar.xz
        syn-$syn.tar.gz::https://crates.io/api/v1/crates/syn/$syn/download
        unicode-ident-$unicodeident.tar.gz::https://crates.io/api/v1/crates/unicode-ident/$unicodeident/download
        quote-$quote.tar.gz::https://crates.io/api/v1/crates/quote/$quote/download
        proc-macro2-$procmacro2.tar.gz::https://crates.io/api/v1/crates/proc-macro2/$procmacro2/download
        paste-$paste.tar.gz::https://crates.io/api/v1/crates/paste/$paste/download     
        crossfile)
noextract=(syn-$syn.tar.gz unicode-ident-$unicodeident.tar.gz quote-$quote.tar.gz proc-macro2-$procmacro2.tar.gz paste-$paste.tar.gz)

build() {
    cd ${_pkgname}-$pkgver

    export BINDGEN_EXTRA_CLANG_ARGS="-m32"
    export PKG_CONFIG_PATH="/usr/lib32/pkgconfig"

    mkdir -p subprojects/packagecache
    cp ../*.tar.gz subprojects/packagecache

    meson setup \
        --prefix=/usr \
        --sysconfdir=/etc \
        --libdir=/usr/lib32 \
        --buildtype=plain \
        --cross-file lib32 \
        -D glvnd=enabled \
        -D platforms=x11,wayland \
        -D gallium-drivers=auto \
        -D vulkan-drivers=auto \
        -D gles1=disabled \
        -D video-codecs=all \
        -D valgrind=disabled \
        -D libunwind=disabled \
        build32
    ninja -C build32
    DESTDIR=$PWD/DESTDIR ninja install -C build32

	# indirect rendering symlink
	ln -s libGLX_mesa.so.0 DESTDIR/usr/lib32/libGLX_indirect.so.0

    [ -d DESTDIR/usr/share/glvnd ] && rm -r DESTDIR/usr/include DESTDIR/usr/share/glvnd
    rm -rf DESTDIR/usr/include DESTDIR/etc/OpenCL
	rm DESTDIR/usr/share/drirc.d/00-mesa-defaults.conf
	rm DESTDIR/usr/share/drirc.d/00-radv-defaults.conf

    rm -f DESTDIR/usr/share/vulkan/implicit_layer.d/VkLayer_MESA_device_select.json
    rm -f DESTDIR/usr/share/vulkan/explicit_layer.d/VkLayer_MESA_overlay.json
    rm -f DESTDIR/usr/share/vulkan/explicit_layer.d/VkLayer_INTEL_nullhw.json
    rm -f DESTDIR/usr/bin/mesa-overlay-control.py
    rm -f DESTDIR/usr/bin/mesa-screenshot-control.py
    rm -f DESTDIR/usr/share/vulkan/explicit_layer.d/VkLayer_MESA_screenshot.json

    cp -Rv DESTDIR/* "$pkgdir"/
}