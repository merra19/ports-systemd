# description	: GNU GRUB boot loader
# depends	: gettext bash xz python efibootmgr freetype flex bison 
# depends	: help2man texinfo ncurses lvm2 fuse unifont

pkgname=grub
pkgver=2.12
pkgrel=2
options=(!makeflags !lto)
source=(https://mirror.lyrahosting.com/gnu/grub/$pkgname-$pkgver.tar.xz
        fstab grub.default update-grub update-efi)
backup=(etc/default/grub etc/grub.d/40_custom etc/fstab)

build() {
    cd $pkgname-$pkgver

    unset CFLAGS
    unset CPPFLAGS
    unset CXXFLAGS
    unset LDFLAGS
    unset MAKEFLAGS

    # Add a file missing from the release tarball:
    echo depends bli part_gpt > grub-core/extra_deps.lst
    
    ./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --disable-efiemu \
        --enable-grub-mkfont \
        --with-platform=efi \
        --target=x86_64 \
        --disable-werror \
        --enable-nls \
        --enable-device-mapper
    make
    make DESTDIR="$pkgdir" install
    
    mkdir -pv "$pkgdir"/usr/share/bash-completion/completions
    mv -v "$pkgdir"/etc/bash_completion.d/grub "$pkgdir"/usr/share/bash-completion/completions
    install -D -m0644 ../grub.default "$pkgdir"/etc/default/grub
    install -D -m0644 ../fstab "$pkgdir"/etc/fstab

    install -Dm0755 ../update-grub "$pkgdir"/usr/bin/update-grub
    install -Dm0755 ../update-efi "$pkgdir"/usr/bin/update-efi
}