# description	: Standard GNU utilities (chmod, cp, dd, ls, sort, tr, head, wc, who,...)
# depends	: glibc acl attr xz perl openssl

pkgname=coreutils
pkgver=9.7
pkgrel=1
source=(https://mirror.lyrahosting.com/gnu/coreutils/$pkgname-$pkgver.tar.xz
        https://www.linuxfromscratch.org/patches/lfs/12.4/$pkgname-$pkgver-i18n-1.patch
        https://www.linuxfromscratch.org/patches/lfs/12.4/coreutils-9.7-upstream_fix-1.patch)

build() {
    cd $pkgname-$pkgver

    # apply a patch for a security problem identified upstream
    patch -Np1 -i ../coreutils-9.7-upstream_fix-1.patch
    # POSIX requires that programs from Coreutils recognize character boundaries correctly
    # even in multibyte locales. The following patch fixes this non-compliance and other
    # internationalization-related bugs. 
    patch -Np1 -i ../coreutils-$pkgver-i18n-1.patch

    autoreconf -fv
    automake -af
    FORCE_UNSAFE_CONFIGURE=1 \
    ./configure \
        --prefix=/usr \
        --enable-no-install-program=kill,uptime 
    make
    make DESTDIR="$pkgdir" install
    
    mkdir -pv "$pkgdir"/usr/share/man/man8/ "$pkgdir"/usr/sbin
    mv -v "$pkgdir"/usr/bin/chroot "$pkgdir"/usr/sbin
    mv -v "$pkgdir"/usr/share/man/man1/chroot.1 "$pkgdir"/usr/share/man/man8/chroot.8
    sed -i 's/"1"/"8"/' "$pkgdir"/usr/share/man/man8/chroot.8
}
