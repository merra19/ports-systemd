# description	: The PHP language runtime engine
# depends	: sqlite libxml2 pcre2 lmdb aspell aspell-en aspell-fr
# depends	: enchant libxslt freetype libexif libjpeg-turbo libpng 
# depends	: libtiff libwebp gdbm xz libxcrypt bzip2 curl acl zlib
# depends	: libffi libgmp icu readline openssl apache tidy-html5
# depends	: unixodbc postgresql xorg-libs mariadb
# optional  : openldap

pkgname=php
pkgver=8.4.11
pkgrel=1
options=(!lto)
source=(https://www.php.net/distributions/$pkgname-$pkgver.tar.xz
        https://pear.php.net/go-pear.phar)
backup=(etc/php-fpm.conf.default etc/php-fpm.d/www.conf.default etc/php.ini)

build() {
	cd $pkgname-$pkgver

    if [ $OPTFLAGS = "yes" ];then
        export LDFLAGS="-Wl,-O1 -Wl,--as-needed -Wl,-z,now,-z,relro,-z,separate-code -Wl,--enable-new-dtags"
    fi

    ./configure \
        --prefix=/usr \
        --sysconfdir=/etc \
        --localstatedir=/var \
        --datadir=/usr/share/php \
        --mandir=/usr/share/man \
        --without-pear \
        --enable-fpm \
        --with-fpm-user=apache \
        --with-fpm-group=apache \
        --with-fpm-systemd \
        --with-config-file-path=/etc \
        --with-zlib \
        --enable-bcmath \
        --with-bz2 \
        --enable-calendar \
        --enable-dba=shared \
        --with-gdbm \
        --with-gmp \
        --enable-ftp \
        --with-gettext \
        --enable-mbstring \
        --disable-mbregex \
        --with-readline   
    make
	make -j1 INSTALL_ROOT="$pkgdir" DESTDIR="$pkgdir" install

    install -v -m644 php.ini-production "$pkgdir"/etc/php.ini &&

    install -v -m755 -d "$pkgdir"/usr/share/doc/$pkgname-$pkgver
    install -v -m644    CODING_STANDARDS* EXTENSIONS NEWS README* UPGRADING* \
                        "$pkgdir"/usr/share/doc/$pkgname-$pkgver

    sed -i 's@php/includes"@&\ninclude_path = ".:/usr/lib/php"@' \
        "$pkgdir"/etc/php.ini
}

