# description	: An object-oriented scripting language
# depends	: gdbm rustc openssl tcl tk libyaml libffi zlib libxcrypt

pkgname=ruby
pkgver=3.4.5
pkgrel=1
options=(!lto)
source=(https://cache.ruby-lang.org/pub/ruby/${pkgver%.*}/$pkgname-$pkgver.tar.xz)

build() {
	cd $pkgname-$pkgver

    if [ "$OPTFLAGS" = "yes" ];then
        export CFLAGS="-O2 -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=64 -Wformat -Wformat-security  -Wno-error -ftree-vectorize -ftree-slp-vectorize -ftrivial-auto-var-init=zero  -ffunction-sections -fasynchronous-unwind-tables -Wp,-D_REENTRANT -fPIC -march=x86-64-v3 $DEBUGFLAGS"
        export CXXFLAGS="$CFLAGS"
    fi

	#CFLAGS=${CFLAGS/-mrelax-cmpxchg-loop/}
	#CXXFLAGS=${CXXFLAGS/-mrelax-cmpxchg-loop/}

    #CC=clang CXX=clang++ \
    ./configure \
        --prefix=/usr \
        --disable-rpath \
        --enable-shared \
        --without-valgrind \
        --without-baseruby \
        ac_cv_func_qsort_r=no \
		--docdir=/usr/share/doc/$pkgname-$pkgver
	make
    make capi
    make DESTDIR="$pkgdir" install 
}
