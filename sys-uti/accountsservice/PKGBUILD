# description	: D-Bus interfaces for querying and manipulating user account information
# depends	: glib libxcrypt polkit docbook-xml gobject-introspection
# depends	: meson xmlto dbus systemd vala

pkgname=accountsservice
pkgver=23.13.9
pkgrel=1
options=(!lto)
source=(https://www.freedesktop.org/software/accountsservice/$pkgname-$pkgver.tar.xz
        40-adm.rules accountsservice-23.13.9-c99-fixes.patch)

build() {
    cd $pkgname-$pkgver

    patch -Np1 -i ../accountsservice-23.13.9-c99-fixes.patch

    # Rename a directory whose presence prevents the build system from running if dbusmock is not installed:
    mv tests/dbusmock tests/dbusmock-tests

    # Fix the tests so that the new directory is found and adapt it for Python 3.12.0 or later
    sed -e '/accounts_service\.py/s/dbusmock/dbusmock-tests/' \
        -e 's/assertEquals/assertEqual/' \
        -i tests/test-libaccountsservice.py

    # Fix one test that fails if the en_IE.UTF-8 locale is not installed:
    sed -i '/^SIMULATED_SYSTEM_LOCALE/s/en_IE.UTF-8/en_HK.iso88591/' tests/test-daemon.py

	meson setup \
        --prefix=/usr \
        --buildtype=plain \
        -D admin_group=adm \
        -D docbook=true \
        -D gtk_doc=false \
        build
	ninja -C build
	DESTDIR="$pkgdir" ninja install -C build

	install -Dm 644  "$srcdir"/40-adm.rules   "$pkgdir"/etc/polkit-1/rules.d/40-adm.rules
}