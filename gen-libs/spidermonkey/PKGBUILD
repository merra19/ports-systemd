# description	: SpiderMonkey is Mozilla's JavaScript engine written in C and C++
# depends	: readline zlib icu which cbindgen

pkgname=spidermonkey
pkgver=140.3.0
pkgrel=1
options=(!lto)
source=(https://archive.mozilla.org/pub/firefox/releases/${pkgver}esr/source/firefox-${pkgver}esr.source.tar.xz)

build() {
    cd firefox-$pkgver

    export CFLAGS="-Os -falign-functions=4 -fno-semantic-interposition -fno-signed-zeros -march=$MMARCH -fno-delete-null-pointer-checks -fno-strict-aliasing "
    export CXXFLAGS="-Os -falign-functions=4 -fno-semantic-interposition -fno-signed-zeros -march=$MMARCH  -fno-delete-null-pointer-checks -fno-strict-aliasing "

    mountpoint -q /dev/shm || mount -t tmpfs devshm /dev/shm

    mkdir obj
    cd    obj

    export CC=gcc CXX=g++

    ../js/src/configure \
            --prefix=/usr \
            --disable-debug-symbols \
            --disable-jemalloc \
            --enable-readline \
            --enable-rust-simd \
            --with-intl-api \
            --with-system-icu \
            --with-system-zlib \
            --enable-optimize="-O3"
    make
    make DESTDIR="$pkgdir" install
    rm -v "$pkgdir"/usr/lib/libjs_static.ajs
    sed -i '/@NSPR_CFLAGS@/d' "$pkgdir"/usr/bin/js140-config

    # Still as the root user, fix an issue with one of the installed headers
    sed '$i#define XP_UNIX' -i "$pkgdir"/usr/include/mozjs-140/js-config.h
}
