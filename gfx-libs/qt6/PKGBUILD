# description	: Cross-platform application development framework
# depends	: zlib openssl zstd double-conversion glib xorg-libs gtk3
# depends	: icu dbus harfbuzz libjpeg-turbo libpng libxkbcommon 
# depends	: xcb-utilities sqlite mesa mtdev libinput libglvnd cups
# depends	: vulkan-headers libproxy alsa-lib make-ca jasper libmng
# depends	: libtiff libwebp wayland bluez llvm pciutils pulseaudio 
# depends	: protobuf systemd
# optional  : krb5 mariadb unixodbc postgresql
# todo      : gst-plugins-base ibus sdl2 speech-dispatcher

pkgname=qt6
pkgver=6.9.2
pkgrel=1
source=(https://download.qt.io/archive/qt/${pkgver:0:3}/$pkgver/single/qt-everywhere-src-$pkgver.tar.xz
		qt6.sh qt6 qt6-base-cflags.patch qt6-base-nostrip.patch 
        assistant-qt6.desktop designer-qt6.desktop linguist-qt6.desktop qdbusviewer-qt6.desktop)

build() {
    cd qt-everywhere-src-$pkgver

	patch -Np1 -i $srcdir/qt6-base-cflags.patch -d qtbase
	patch -Np1 -i $srcdir/qt6-base-nostrip.patch -d qtbase

	mkdir -pv qtbase/.git

    ./configure \
        -prefix /usr  \
        -sysconfdir /etc/xdg \
        -archdatadir /usr/lib/qt6 \
        -bindir /usr/lib/qt6/bin  \
        -libexecdir /usr/lib/qt6 \
        -plugindir /usr/lib/qt6/plugins \
        -headerdir /usr/include/qt6 \
        -datadir /usr/share/qt6 \
        -docdir /usr/share/doc/qt6 \
        -translationdir /usr/share/qt6/translations \
        -examplesdir /usr/share/doc/qt6/examples \
        -dbus-linked \
        -openssl-linked \
        -system-sqlite \
        -nomake examples \
        -no-rpath \
        -no-sbom \
        -journald \
        -libproxy \
        -skip qt3d \
        -skip qtquick3dphysics \
        -skip qtwebengine
    ninja
    DESTDIR="$pkgdir" ninja install

	find "$pkgdir"/ -name \*.prl \
		-exec sed -i -e '/^QMAKE_PRL_BUILD_DIR/d' {} \;

    pushd qttools/src

	install -v -dm755 "$pkgdir"/usr/share/pixmaps/

	install -v -Dm644 assistant/assistant/images/assistant-128.png \
					"$pkgdir"/usr/share/pixmaps/assistant-qt6.png

	install -v -Dm644 designer/src/designer/images/designer.png \
					"$pkgdir"/usr/share/pixmaps/designer-qt6.png

	install -v -Dm644 linguist/linguist/images/icons/linguist-128-32.png \
					"$pkgdir"/usr/share/pixmaps/linguist-qt6.png 

	install -v -Dm644 qdbus/qdbusviewer/images/qdbusviewer-128.png \
					"$pkgdir"/usr/share/pixmaps/qdbusviewer-qt6.png
    popd
    
    install -dm755 "$pkgdir"/usr/share/applications

    for i in assistant-qt6.desktop designer-qt6.desktop linguist-qt6.desktop \
        qdbusviewer-qt6.desktop ;do
        install -Dm644 "$srcdir"/$i "$pkgdir"/usr/share/applications/$i
    done

    install -Dm 755 "$srcdir"/qt6.sh "$pkgdir"/etc/profile.d/qt6.sh
    install -Dm 644 "$srcdir"/qt6 "$pkgdir"/etc/sudoers.d/qt6

	# Install useful symlinks
	install -d "$pkgdir"/usr/bin
	for file in "$pkgdir"/usr/lib/qt6/bin/*; do
		ln -s ../lib/qt6/bin/$(basename $file) "$pkgdir"/usr/bin/$(basename $file)-qt6
		#ln -s ../lib/qt6/bin/$(basename $file) $pkgdir/usr/bin/$(basename $file)
	done
}
