# description	: An enhanced, drop-in replacement for MySQL
# depends	: pcre2 texinfo ncurses zlib libxcrypt binutils readline 
# depends	: libaio procps-ng bzip2 xz boost libevent libxml2 lz4
# depends	: lzo bison cmake pam openssl fmt ruby
# depends	: unixodbc snowball-stemmer
# optional	: krb5 openldap

pkgname=mariadb
pkgver=11.8.3
pkgrel=1
options=(!lto)
source=(https://downloads.mariadb.org/interstitial/mariadb-$pkgver/source/$pkgname-$pkgver.tar.gz
        my.cnf $pkgname.hooks)
backup=(etc/mariadb/my.cnf)
 
build() {
	cd $pkgname-$pkgver

    # Fix an issue with detecting Boost-1.89.0 and late
    sed -i 's/regex system/regex/' \
        storage/columnstore/columnstore/cmake/boost.cmake

    cmake -B build \
        -D CMAKE_BUILD_TYPE=Release \
        -D CMAKE_INSTALL_PREFIX=/usr \
        -D GRN_LOG_PATH=/var/log/groonga.log \
        -D INSTALL_DOCDIR=share/doc/mariadb-$pkgver \
        -D INSTALL_DOCREADMEDIR=share/doc/mariadb-$pkgver \
        -D INSTALL_MANDIR=share/man \
        -D INSTALL_MYSQLSHAREDIR=share/mariadb \
        -D INSTALL_MYSQLTESTDIR=share/mariadb/test \
        -D INSTALL_PAMDIR=lib/security \
        -D INSTALL_PAMDATADIR=/etc/security \
        -D INSTALL_PLUGINDIR=lib/mariadb/plugin \
        -D INSTALL_SBINDIR=sbin \
        -D INSTALL_SCRIPTDIR=bin \
        -D INSTALL_SQLBENCHDIR=share/mariadb/bench \
        -D INSTALL_SUPPORTFILESDIR=share/mariadb \
        -D MYSQL_DATADIR=/srv/mariadb \
        -D MYSQL_UNIX_ADDR=/run/mariadb/mariadb.sock \
        -D WITH_EXTRA_CHARSETS=complex \
        -D WITH_EMBEDDED_SERVER=ON \
        -D SKIP_TESTS=ON \
        -D TOKUDB_OK=0 \
        -W no-dev
    make -C build
    make -j1 DESTDIR="$pkgdir" install -C build

    install -v -dm 755 "$pkgdir"/etc/mariadb
    install -Dm644 "$srcdir"/my.cnf "$pkgdir"/etc/mariadb/my.cnf

    install -Dm755 "$srcdir"/$pkgname.hooks "$pkgdir"/usr/share/blfs-bootscripts/hooks/$pkgname.hooks
}
