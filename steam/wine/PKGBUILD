# description	: A compatibility layer for running Windows programs
# depends	: attr desktop-file-utils fontconfig freetype gcc gettext
# depends	: libpcap xorg-libs wayland alsa-lib pulseaudio mesa
# depends	: ffmpeg giflib gnutls gtk3 cups libva vulkan-loader
# depends	: mingw-w64-gcc opencl-headers opencl-loader
# depends	: perl sdl2 v4l-utils mingw-w64-winpthreads
# optional  : gstreamer!!gst-plugins-base
# todo      : libgphoto2

pkgname=wine
pkgver=10.15
pkgrel=1
options=(!lto !strip)
source=(https://dl.winehq.org/wine/source/10.x/$pkgname-$pkgver.tar.xz)

build() {
    mkdir $pkgname-64-build
    cd "$srcdir/$pkgname-64-build"

    unset CFLAGS CXXFLAGS LDFLAGS

    # Apply flags for cross-compilation
    export CROSSCFLAGS="-O2 -pipe"
    export CROSSCXXFLAGS="-O2 -pipe"
    export CROSSLDFLAGS="-Wl,-O1"

    ../$pkgname-$pkgver/configure \
        --prefix=/usr \
        --libdir=/usr/lib \
        --enable-archs=x86_64,i386
    make
    make prefix="$pkgdir/usr" \
        libdir="$pkgdir/usr/lib" \
        dlldir="$pkgdir/usr/lib/wine" install

    i686-w64-mingw32-strip --strip-unneeded "$pkgdir"/usr/lib/wine/i386-windows/*.dll
    x86_64-w64-mingw32-strip --strip-unneeded "$pkgdir"/usr/lib/wine/x86_64-windows/*.dll

	install -dm0755 "$pkgdir/etc/revdep.d/"
	echo '/usr/lib/wine/x86_64-unix/' > "$pkgdir/etc/revdep.d/wine.conf"
}
