# description	: Cross binutils for the MinGW-w64 cross-compiler
# depends	: glibc zlib zstd

pkgname=mingw-w64-binutils
pkgver=2.45
pkgrel=1
options=(!libtool !emptydirs)
source=(https://mirror.lyrahosting.com/gnu/binutils/binutils-${pkgver}.tar.xz)

build() {
    cd "$srcdir"/binutils-${pkgver}

    #do not install libiberty
    sed -i 's/install_to_$(INSTALL_DEST) //' libiberty/Makefile.in

    #unset CFLAGS CXXFLAGS LDFLAGS
    
    mkdir build-x86_64 &&
    cd    build-x86_64 &&

    "$srcdir"/binutils-${pkgver}/configure \
        --prefix=/usr \
        --target=x86_64-w64-mingw32 \
        --infodir=/usr/share/info/x86_64-w64-mingw32 \
        --enable-lto --enable-plugins \
        --enable-deterministic-archives \
        --disable-multilib \
        --disable-nls \
        --disable-werror
    make
    make DESTDIR="$pkgdir" install
    cd -

    mkdir build-i686
    cd    build-i686

    "$srcdir"/binutils-${pkgver}/configure \
        --prefix=/usr \
        --target=i686-w64-mingw32 \
        --infodir=/usr/share/info/i686-w64-mingw32 \
        --enable-lto --enable-plugins \
        --enable-deterministic-archives \
        --disable-multilib \
        --disable-nls \
        --disable-werror
    make
    make DESTDIR="$pkgdir" install

    rm -v  "$pkgdir"/usr/lib/bfd-plugins/libdep.so 
}
