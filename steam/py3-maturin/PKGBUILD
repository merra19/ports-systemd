# description	: Build and publish crates with pyo3, rust-cpython and cffi bindings - Python bindings
# depends	: python py3-gpep517 py3-setuptools py3-wheel bzip2 rustc
# depends	: dbus openssl py3-setuptools-rust py3-semantic-version

pkgname=py3-maturin
pkgver=1.9.4
pkgrel=1
source=($pkgname-$pkgver.tar.gz::https://github.com/PyO3/maturin/archive/v$pkgver.tar.gz
		local://$pkgname-$pkgver-cargo.tar.xz)

_features="--features=full,native-tls,password-storage"

createpack() {
    mkdir -p vendor
    cargo vendor vendor
    tar -cJpf $pkgname-$pkgver-cargo.tar.xz vendor/
    cp $pkgname-$pkgver-cargo.tar.xz /sources/src/
}

build() {
	cd maturin-$pkgver

	#createpack

    mv "$srcdir"/vendor .

    mkdir -p .cargo
    echo '[source.crates-io]' >> .cargo/config.toml
    echo 'replace-with = "vendored-sources"' >> .cargo/config.toml
    echo '[source.vendored-sources]' >> .cargo/config.toml
    echo 'directory = "vendor"' >> .cargo/config.toml

	#cargo build --release

	export OPENSSL_NO_VENDOR=1

	export MATURIN_SETUP_ARGS="--no-default-features $_features"

	gpep517 build-wheel --wheel-dir .dist --output-fd 3 3>&1 >&2

	./target/release/maturin completions bash > $pkgname.bash
	./target/release/maturin completions fish > $pkgname.fish
	./target/release/maturin completions zsh > $pkgname.zsh

	install -Dm644 $pkgname.bash "$pkgdir"/usr/share/bash-completion/completions/$pkgname
	install -Dm644 $pkgname.fish "$pkgdir"/usr/share/fish/vendor_completions.d/$pkgname.fish
	install -Dm644 $pkgname.zsh "$pkgdir"/usr/share/zsh/site-functions/_$pkgname

	python3 -m installer -d "$pkgdir" .dist/*.whl
}