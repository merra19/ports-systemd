# description	: X C-language Bindings sample implementations
# depends	: libxcvt pixman libglvnd openssl xorg-fonts dbus
# depends	: xkeyboard-config systemd libepoxy libtirpc libunwind
# depends	: nettle libgcrypt xcb-utilities xmlto mesa

pkgname=xlibre-xserver
pkgver=25.0.0.11
pkgrel=1
source=(https://github.com/X11Libre/xserver/archive/refs/tags/$pkgname-$pkgver.tar.gz
        xvfb-run xvfb-run.1
        xlibre-server-1.12-unloadsubmodule.patch
        xlibre-server-1.18-support-multiple-Files-sections.patch)

build() { 
    cd xserver-$pkgname-$pkgver
  
    export CFLAGS=${CFLAGS/-fno-plt}
    export CXXFLAGS=${CXXFLAGS/-fno-plt}
    #export LDFLAGS=${LDFLAGS/-Wl,-z,now}
    LDFLAGS="$LDFLAGS -Wl,-z,lazy $DEBUGFLAGS"

    export LDFLAG

    #patch -Np1 -i ../xlibre-server-1.12-unloadsubmodule.patch
    #patch -Np1 -i ../xlibre-server-1.18-support-multiple-Files-sections.patch


	meson setup \
        --prefix=/usr \
        --buildtype=plain \
        --localstatedir=/var \
        -D glamor=true \
        -D xkb_output_dir=/var/lib/xkb \
        build
	ninja -C build
	DESTDIR="$pkgdir" ninja install -C build

    chmod u+s "$pkgdir"/usr/bin/Xorg   

    mkdir -pv "$pkgdir"/etc/X11/xorg.conf.d 

    install -m755 "$srcdir/xvfb-run" "$pkgdir/usr/bin/"
    install -m644 "$srcdir/xvfb-run.1" "$pkgdir/usr/share/man/man1/"
}
